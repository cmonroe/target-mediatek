From 241cff7cc469cf644ff8e7903ed8ef8e86fe10b8 Mon Sep 17 00:00:00 2001
From: Tim Hayes <tim.hayes@smartrg.com>
Date: Fri, 6 Nov 2020 08:37:19 -0800
Subject: [PATCH] OWRT-5691 shens mtu fix added

---
 drivers/net/ethernet/mediatek/mtk_eth_soc.c | 8 +++++---
 drivers/net/ethernet/mediatek/mtk_eth_soc.h | 6 +++++-
 2 files changed, 10 insertions(+), 4 deletions(-)

Index: linux-5.10.52/drivers/net/ethernet/mediatek/mtk_eth_soc.c
===================================================================
--- linux-5.10.52.orig/drivers/net/ethernet/mediatek/mtk_eth_soc.c
+++ linux-5.10.52/drivers/net/ethernet/mediatek/mtk_eth_soc.c
@@ -355,8 +355,10 @@ static void mtk_mac_config(struct phylin
 	/* Setup gmac */
 	mcr_cur = mtk_r32(mac->hw, MTK_MAC_MCR(mac->id));
 	mcr_new = mcr_cur;
-	mcr_new |= MAC_MCR_MAX_RX_1536 | MAC_MCR_IPG_CFG | MAC_MCR_FORCE_MODE |
-		   MAC_MCR_BACKOFF_EN | MAC_MCR_BACKPR_EN | MAC_MCR_FORCE_LINK;
+	mcr_new |= (MTK_7531_JUMBO_KLENGTH << MAC_MCR_RX_JUMBO_SHIFT) |
+			MAC_MCR_MAX_RX_JUMBO |
+			MAC_MCR_IPG_CFG | MAC_MCR_FORCE_MODE |
+			MAC_MCR_BACKOFF_EN | MAC_MCR_BACKPR_EN | MAC_MCR_FORCE_LINK;
 
 	/* Only update control register when needed! */
 	if (mcr_new != mcr_cur)
@@ -1706,7 +1708,7 @@ static int mtk_rx_alloc(struct mtk_eth *
 		rx_data_len = MTK_MAX_LRO_RX_LENGTH;
 		rx_dma_size = MTK_HW_LRO_DMA_SIZE;
 	} else {
-		rx_data_len = ETH_DATA_LEN;
+		rx_data_len = MTK_MAX_RX_LENGTH;
 		rx_dma_size = MTK_DMA_SIZE;
 	}
 
@@ -3004,7 +3006,7 @@ static int mtk_add_mac(struct mtk_eth *e
 	eth->netdev[id]->irq = eth->irq[0];
 	eth->netdev[id]->dev.of_node = np;
 
-	eth->netdev[id]->max_mtu = MTK_MAX_RX_LENGTH - MTK_RX_ETH_HLEN;
+	eth->netdev[id]->max_mtu = ETH_MAX_MTU;
 
 	return 0;
 
Index: linux-5.10.52/drivers/net/ethernet/mediatek/mtk_eth_soc.h
===================================================================
--- linux-5.10.52.orig/drivers/net/ethernet/mediatek/mtk_eth_soc.h
+++ linux-5.10.52/drivers/net/ethernet/mediatek/mtk_eth_soc.h
@@ -20,7 +20,8 @@
 #include "mtk_ppe.h"
 
 #define MTK_QDMA_PAGE_SIZE	2048
-#define	MTK_MAX_RX_LENGTH	1536
+#define	MTK_7531_JUMBO_KLENGTH	11
+#define	MTK_MAX_RX_LENGTH	(MTK_7531_JUMBO_KLENGTH * 1024)
 #define MTK_TX_DMA_BUF_LEN	0x3fff
 #define MTK_DMA_SIZE		512
 #define MTK_NAPI_WEIGHT		64
@@ -352,7 +353,10 @@
 
 /* Mac control registers */
 #define MTK_MAC_MCR(x)		(0x10100 + (x * 0x100))
+#define MAC_MCR_RX_JUMBO_SHIFT	28
 #define MAC_MCR_MAX_RX_1536	BIT(24)
+#define MAC_MCR_MAX_RX_1552	BIT(25)
+#define MAC_MCR_MAX_RX_JUMBO	(MAC_MCR_MAX_RX_1536 | MAC_MCR_MAX_RX_1552)
 #define MAC_MCR_IPG_CFG		(BIT(18) | BIT(16))
 #define MAC_MCR_FORCE_MODE	BIT(15)
 #define MAC_MCR_TX_EN		BIT(14)
